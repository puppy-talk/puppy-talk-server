<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppy Talk WebSocket 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .connection-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b2b7;
        }
        .setup-section {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .setup-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .setup-section input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .setup-section button {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .setup-section button:hover {
            background-color: #1976D2;
        }
        .setup-section button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: 20px;
            text-align: right;
        }
        .pet-message {
            background-color: #f1f8e9;
            margin-right: 20px;
        }
        .system-message {
            background-color: #fff3e0;
            text-align: center;
            font-style: italic;
        }
        .typing-indicator {
            background-color: #e0e0e0;
            margin-right: 20px;
            font-style: italic;
            color: #666;
        }
        .message-input {
            display: flex;
            gap: 10px;
        }
        .message-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .message-input button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message-input button:hover {
            background-color: #45a049;
        }
        .message-input button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .typing-controls {
            margin: 10px 0;
        }
        .typing-controls button {
            background-color: #FF9800;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .typing-controls button:hover {
            background-color: #F57C00;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 2px;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #17a2b8;
        }
        .log-success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐶 Puppy Talk WebSocket 테스트 페이지</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            연결 안됨
        </div>
        
        <div class="setup-section">
            <h3>인증 및 연결 설정</h3>
            
            <div id="authSection">
                <h4>🔐 사용자 인증</h4>
                <label for="username">사용자명:</label>
                <input type="text" id="username" value="testuser1" />
                
                <label for="password">패스워드:</label>
                <input type="password" id="password" value="password123" />
                
                <button id="loginBtn" onclick="login()">로그인</button>
                <button id="registerBtn" onclick="register()">회원가입</button>
                
                <div id="authStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;">
                    <span id="authMessage"></span>
                </div>
            </div>
            
            <hr style="margin: 20px 0;">
            
            <div id="connectionSection" style="display: none;">
                <h4>🔗 WebSocket 연결</h4>
                <label for="serverUrl">서버 URL:</label>
                <input type="text" id="serverUrl" value="http://localhost:8080" />
                
                <label for="chatRoomId">채팅방 ID:</label>
                <input type="number" id="chatRoomId" value="1" />
                
                <button id="connectBtn" onclick="connect()">WebSocket 연결</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>연결 해제</button>
            </div>
        </div>
        
        <div class="chat-container" id="chatMessages">
            <div class="system-message">채팅방에 연결하세요</div>
        </div>
        
        <div class="typing-controls">
            <button onclick="startTyping()" id="startTypingBtn" disabled>타이핑 시작</button>
            <button onclick="stopTyping()" id="stopTypingBtn" disabled>타이핑 중단</button>
            <button onclick="markAsRead()" id="markReadBtn" disabled>읽음 처리</button>
        </div>
        
        <div class="message-input">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." 
                   onkeypress="handleKeyPress(event)" disabled />
            <button onclick="sendMessage()" id="sendBtn" disabled>전송</button>
        </div>
        
        <div class="logs" id="logs">
            <div class="log-entry">로그가 여기에 표시됩니다...</div>
        </div>
    </div>

    <!-- SockJS와 STOMP 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    
    <script>
        let stompClient = null;
        let isConnected = false;
        let currentChatRoomId = null;
        let currentUserId = null;
        let authToken = null;
        let typingTimeout = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // JWT 인증 함수들
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showAuthStatus('사용자명과 패스워드를 입력해주세요.', 'error');
                return;
            }
            
            log(`로그인 시도: ${username}`, 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentUserId = result.user.id;
                    showAuthStatus(`로그인 성공: ${result.user.username}`, 'success');
                    log(`로그인 성공: userId=${currentUserId}`, 'success');
                    
                    // WebSocket 연결 섹션 표시
                    document.getElementById('connectionSection').style.display = 'block';
                } else {
                    showAuthStatus(result.message || '로그인 실패', 'error');
                    log(`로그인 실패: ${result.message}`, 'error');
                }
            } catch (error) {
                showAuthStatus('로그인 요청 중 오류 발생', 'error');
                log(`로그인 오류: ${error.message}`, 'error');
            }
        }
        
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = `${username}@example.com`; // 간단한 이메일 생성
            
            if (!username || !password) {
                showAuthStatus('사용자명과 패스워드를 입력해주세요.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthStatus('패스워드는 최소 6자 이상이어야 합니다.', 'error');
                return;
            }
            
            log(`회원가입 시도: ${username}`, 'info');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentUserId = result.user.id;
                    showAuthStatus(`회원가입 성공: ${result.user.username}`, 'success');
                    log(`회원가입 성공: userId=${currentUserId}`, 'success');
                    
                    // WebSocket 연결 섹션 표시
                    document.getElementById('connectionSection').style.display = 'block';
                } else {
                    showAuthStatus(result.message || '회원가입 실패', 'error');
                    log(`회원가입 실패: ${result.message}`, 'error');
                }
            } catch (error) {
                showAuthStatus('회원가입 요청 중 오류 발생', 'error');
                log(`회원가입 오류: ${error.message}`, 'error');
            }
        }
        
        function showAuthStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            const messageEl = document.getElementById('authMessage');
            
            messageEl.textContent = message;
            statusEl.className = type === 'success' ? 'connected' : 'disconnected';
            statusEl.style.display = 'block';
            
            // 3초 후 메시지 숨김
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusEl.textContent = `연결됨 - 채팅방 ${currentChatRoomId} (사용자: ${currentUserId})`;
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = '연결 안됨';
                statusEl.className = 'connection-status disconnected';
            }
            
            // 버튼 상태 업데이트
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('messageInput').disabled = !connected;
            document.getElementById('sendBtn').disabled = !connected;
            document.getElementById('startTypingBtn').disabled = !connected;
            document.getElementById('stopTypingBtn').disabled = !connected;
            document.getElementById('markReadBtn').disabled = !connected;
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            currentChatRoomId = document.getElementById('chatRoomId').value;
            
            if (!serverUrl || !currentChatRoomId) {
                alert('서버 URL과 채팅방 ID를 입력해주세요.');
                return;
            }
            
            if (!authToken) {
                alert('먼저 로그인해주세요.');
                return;
            }
            
            log(`연결 시도: ${serverUrl}/ws`);
            
            const socket = new SockJS(`${serverUrl}/ws`);
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                connectHeaders: {
                    'Authorization': `Bearer ${authToken}`
                },
                debug: function (str) {
                    log(`STOMP: ${str}`, 'info');
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            stompClient.onConnect = function (frame) {
                log('WebSocket 연결 성공!', 'success');
                updateConnectionStatus(true);
                subscribeToChannels();
                addSystemMessage('채팅방에 연결되었습니다.');
            };

            stompClient.onWebSocketError = function (error) {
                log(`WebSocket 오류: ${error}`, 'error');
            };

            stompClient.onStompError = function (frame) {
                log(`STOMP 오류: ${frame.headers['message']}`, 'error');
                log(`상세: ${frame.body}`, 'error');
            };

            stompClient.onDisconnect = function () {
                log('WebSocket 연결 해제됨');
                updateConnectionStatus(false);
            };

            stompClient.activate();
        }

        function subscribeToChannels() {
            // 채팅 메시지 구독
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}`, function (message) {
                const chatMessage = JSON.parse(message.body);
                log(`메시지 수신: ${JSON.stringify(chatMessage)}`, 'success');
                addChatMessage(chatMessage);
            });

            // 타이핑 상태 구독
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}/typing`, function (message) {
                const typingMessage = JSON.parse(message.body);
                log(`타이핑 상태: ${JSON.stringify(typingMessage)}`, 'info');
                handleTypingStatus(typingMessage);
            });

            // 읽음 상태 구독
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}/read`, function (message) {
                const readReceipt = JSON.parse(message.body);
                log(`읽음 확인: ${JSON.stringify(readReceipt)}`, 'info');
            });

            // 시스템 메시지 구독
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}/system`, function (message) {
                const systemMessage = JSON.parse(message.body);
                log(`시스템 메시지: ${JSON.stringify(systemMessage)}`, 'info');
                addSystemMessage(systemMessage.content);
            });

            // 개인 메시지 구독
            stompClient.subscribe(`/user/${currentUserId}/queue/messages`, function (message) {
                const privateMessage = JSON.parse(message.body);
                log(`개인 메시지: ${JSON.stringify(privateMessage)}`, 'info');
            });
        }

        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
                stompClient = null;
            }
            updateConnectionStatus(false);
            addSystemMessage('연결이 해제되었습니다.');
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !isConnected) {
                return;
            }

            const messageRequest = {
                userId: parseInt(currentUserId),
                content: content
            };

            log(`메시지 전송: ${JSON.stringify(messageRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/send`,
                body: JSON.stringify(messageRequest)
            });

            messageInput.value = '';
        }

        function startTyping() {
            if (!isConnected) return;

            const typingRequest = {
                userId: parseInt(currentUserId),
                isTyping: true
            };

            log(`타이핑 시작: ${JSON.stringify(typingRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/typing`,
                body: JSON.stringify(typingRequest)
            });
        }

        function stopTyping() {
            if (!isConnected) return;

            const typingRequest = {
                userId: parseInt(currentUserId),
                isTyping: false
            };

            log(`타이핑 중단: ${JSON.stringify(typingRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/typing`,
                body: JSON.stringify(typingRequest)
            });
        }

        function markAsRead() {
            if (!isConnected) return;

            const readRequest = {
                userId: parseInt(currentUserId),
                lastReadMessageId: null
            };

            log(`읽음 처리: ${JSON.stringify(readRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/read`,
                body: JSON.stringify(readRequest)
            });
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            
            const senderType = message.senderType;
            const content = message.content;
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            
            if (senderType === 'USER') {
                messageEl.className = 'message user-message';
                messageEl.innerHTML = `<strong>나:</strong> ${content} <small>(${timestamp})</small>`;
            } else if (senderType === 'PET') {
                messageEl.className = 'message pet-message';
                messageEl.innerHTML = `<strong>🐶 펫:</strong> ${content} <small>(${timestamp})</small>`;
            } else if (senderType === 'SYSTEM') {
                messageEl.className = 'message system-message';
                messageEl.innerHTML = `<strong>시스템:</strong> ${content} <small>(${timestamp})</small>`;
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message system-message';
            messageEl.innerHTML = `<strong>시스템:</strong> ${content}`;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleTypingStatus(typingMessage) {
            const chatMessages = document.getElementById('chatMessages');
            const existingTyping = document.getElementById('typing-indicator');
            
            if (existingTyping) {
                existingTyping.remove();
            }
            
            if (typingMessage.messageType === 'TYPING' && 
                typingMessage.userId.id != currentUserId) {
                const typingEl = document.createElement('div');
                typingEl.id = 'typing-indicator';
                typingEl.className = 'message typing-indicator';
                typingEl.innerHTML = '🐶 펫이 타이핑 중...';
                chatMessages.appendChild(typingEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // 페이지 로드 완료 후 초기화
        window.addEventListener('load', function() {
            log('페이지 로드 완료. 연결 버튼을 클릭하여 WebSocket에 연결하세요.');
        });

        // 페이지 언로드 시 연결 해제
        window.addEventListener('beforeunload', function() {
            if (isConnected) {
                disconnect();
            }
        });
    </script>
</body>
</html>