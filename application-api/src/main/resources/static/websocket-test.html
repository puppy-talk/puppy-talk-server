<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppy Talk WebSocket í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .connection-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b2b7;
        }
        .setup-section {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .setup-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .setup-section input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .setup-section button {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .setup-section button:hover {
            background-color: #1976D2;
        }
        .setup-section button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: 20px;
            text-align: right;
        }
        .pet-message {
            background-color: #f1f8e9;
            margin-right: 20px;
        }
        .system-message {
            background-color: #fff3e0;
            text-align: center;
            font-style: italic;
        }
        .typing-indicator {
            background-color: #e0e0e0;
            margin-right: 20px;
            font-style: italic;
            color: #666;
        }
        .message-input {
            display: flex;
            gap: 10px;
        }
        .message-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .message-input button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message-input button:hover {
            background-color: #45a049;
        }
        .message-input button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .typing-controls {
            margin: 10px 0;
        }
        .typing-controls button {
            background-color: #FF9800;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .typing-controls button:hover {
            background-color: #F57C00;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 2px;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #17a2b8;
        }
        .log-success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¶ Puppy Talk WebSocket í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
        
        <div id="connectionStatus" class="connection-status disconnected">
            ì—°ê²° ì•ˆë¨
        </div>
        
        <div class="setup-section">
            <h3>ì¸ì¦ ë° ì—°ê²° ì„¤ì •</h3>
            
            <div id="authSection">
                <h4>ğŸ” ì‚¬ìš©ì ì¸ì¦</h4>
                <label for="username">ì‚¬ìš©ìëª…:</label>
                <input type="text" id="username" value="testuser1" />
                
                <label for="password">íŒ¨ìŠ¤ì›Œë“œ:</label>
                <input type="password" id="password" value="password123" />
                
                <button id="loginBtn" onclick="login()">ë¡œê·¸ì¸</button>
                <button id="registerBtn" onclick="register()">íšŒì›ê°€ì…</button>
                
                <div id="authStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;">
                    <span id="authMessage"></span>
                </div>
            </div>
            
            <hr style="margin: 20px 0;">
            
            <div id="connectionSection" style="display: none;">
                <h4>ğŸ”— WebSocket ì—°ê²°</h4>
                <label for="serverUrl">ì„œë²„ URL:</label>
                <input type="text" id="serverUrl" value="http://localhost:8080" />
                
                <label for="chatRoomId">ì±„íŒ…ë°© ID:</label>
                <input type="number" id="chatRoomId" value="1" />
                
                <button id="connectBtn" onclick="connect()">WebSocket ì—°ê²°</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
            </div>
        </div>
        
        <div class="chat-container" id="chatMessages">
            <div class="system-message">ì±„íŒ…ë°©ì— ì—°ê²°í•˜ì„¸ìš”</div>
        </div>
        
        <div class="typing-controls">
            <button onclick="startTyping()" id="startTypingBtn" disabled>íƒ€ì´í•‘ ì‹œì‘</button>
            <button onclick="stopTyping()" id="stopTypingBtn" disabled>íƒ€ì´í•‘ ì¤‘ë‹¨</button>
            <button onclick="markAsRead()" id="markReadBtn" disabled>ì½ìŒ ì²˜ë¦¬</button>
        </div>
        
        <div class="message-input">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                   onkeypress="handleKeyPress(event)" disabled />
            <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡</button>
        </div>
        
        <div class="logs" id="logs">
            <div class="log-entry">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>

    <!-- SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    
    <script>
        let stompClient = null;
        let isConnected = false;
        let currentChatRoomId = null;
        let currentUserId = null;
        let authToken = null;
        let typingTimeout = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // JWT ì¸ì¦ í•¨ìˆ˜ë“¤
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showAuthStatus('ì‚¬ìš©ìëª…ê³¼ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            log(`ë¡œê·¸ì¸ ì‹œë„: ${username}`, 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentUserId = result.user.id;
                    showAuthStatus(`ë¡œê·¸ì¸ ì„±ê³µ: ${result.user.username}`, 'success');
                    log(`ë¡œê·¸ì¸ ì„±ê³µ: userId=${currentUserId}`, 'success');
                    
                    // WebSocket ì—°ê²° ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('connectionSection').style.display = 'block';
                } else {
                    showAuthStatus(result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                    log(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.message}`, 'error');
                }
            } catch (error) {
                showAuthStatus('ë¡œê·¸ì¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = `${username}@example.com`; // ê°„ë‹¨í•œ ì´ë©”ì¼ ìƒì„±
            
            if (!username || !password) {
                showAuthStatus('ì‚¬ìš©ìëª…ê³¼ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthStatus('íŒ¨ìŠ¤ì›Œë“œëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            log(`íšŒì›ê°€ì… ì‹œë„: ${username}`, 'info');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentUserId = result.user.id;
                    showAuthStatus(`íšŒì›ê°€ì… ì„±ê³µ: ${result.user.username}`, 'success');
                    log(`íšŒì›ê°€ì… ì„±ê³µ: userId=${currentUserId}`, 'success');
                    
                    // WebSocket ì—°ê²° ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('connectionSection').style.display = 'block';
                } else {
                    showAuthStatus(result.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨', 'error');
                    log(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${result.message}`, 'error');
                }
            } catch (error) {
                showAuthStatus('íšŒì›ê°€ì… ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`íšŒì›ê°€ì… ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        function showAuthStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            const messageEl = document.getElementById('authMessage');
            
            messageEl.textContent = message;
            statusEl.className = type === 'success' ? 'connected' : 'disconnected';
            statusEl.style.display = 'block';
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¹€
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusEl.textContent = `ì—°ê²°ë¨ - ì±„íŒ…ë°© ${currentChatRoomId} (ì‚¬ìš©ì: ${currentUserId})`;
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'ì—°ê²° ì•ˆë¨';
                statusEl.className = 'connection-status disconnected';
            }
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('messageInput').disabled = !connected;
            document.getElementById('sendBtn').disabled = !connected;
            document.getElementById('startTypingBtn').disabled = !connected;
            document.getElementById('stopTypingBtn').disabled = !connected;
            document.getElementById('markReadBtn').disabled = !connected;
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            currentChatRoomId = document.getElementById('chatRoomId').value;
            
            if (!serverUrl || !currentChatRoomId) {
                alert('ì„œë²„ URLê³¼ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!authToken) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            log(`ì—°ê²° ì‹œë„: ${serverUrl}/ws`);
            
            const socket = new SockJS(`${serverUrl}/ws`);
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                connectHeaders: {
                    'Authorization': `Bearer ${authToken}`
                },
                debug: function (str) {
                    log(`STOMP: ${str}`, 'info');
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            stompClient.onConnect = function (frame) {
                log('WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                updateConnectionStatus(true);
                subscribeToChannels();
                addSystemMessage('ì±„íŒ…ë°©ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };

            stompClient.onWebSocketError = function (error) {
                log(`WebSocket ì˜¤ë¥˜: ${error}`, 'error');
            };

            stompClient.onStompError = function (frame) {
                log(`STOMP ì˜¤ë¥˜: ${frame.headers['message']}`, 'error');
                log(`ìƒì„¸: ${frame.body}`, 'error');
            };

            stompClient.onDisconnect = function () {
                log('WebSocket ì—°ê²° í•´ì œë¨');
                updateConnectionStatus(false);
            };

            stompClient.activate();
        }

        function subscribeToChannels() {
            // ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}`, function (message) {
                const chatMessage = JSON.parse(message.body);
                log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${JSON.stringify(chatMessage)}`, 'success');
                addChatMessage(chatMessage);
            });

            // íƒ€ì´í•‘ ìƒíƒœ êµ¬ë…
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}/typing`, function (message) {
                const typingMessage = JSON.parse(message.body);
                log(`íƒ€ì´í•‘ ìƒíƒœ: ${JSON.stringify(typingMessage)}`, 'info');
                handleTypingStatus(typingMessage);
            });

            // ì½ìŒ ìƒíƒœ êµ¬ë…
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}/read`, function (message) {
                const readReceipt = JSON.parse(message.body);
                log(`ì½ìŒ í™•ì¸: ${JSON.stringify(readReceipt)}`, 'info');
            });

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe(`/topic/chat/${currentChatRoomId}/system`, function (message) {
                const systemMessage = JSON.parse(message.body);
                log(`ì‹œìŠ¤í…œ ë©”ì‹œì§€: ${JSON.stringify(systemMessage)}`, 'info');
                addSystemMessage(systemMessage.content);
            });

            // ê°œì¸ ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe(`/user/${currentUserId}/queue/messages`, function (message) {
                const privateMessage = JSON.parse(message.body);
                log(`ê°œì¸ ë©”ì‹œì§€: ${JSON.stringify(privateMessage)}`, 'info');
            });
        }

        function disconnect() {
            if (stompClient) {
                stompClient.deactivate();
                stompClient = null;
            }
            updateConnectionStatus(false);
            addSystemMessage('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !isConnected) {
                return;
            }

            const messageRequest = {
                userId: parseInt(currentUserId),
                content: content
            };

            log(`ë©”ì‹œì§€ ì „ì†¡: ${JSON.stringify(messageRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/send`,
                body: JSON.stringify(messageRequest)
            });

            messageInput.value = '';
        }

        function startTyping() {
            if (!isConnected) return;

            const typingRequest = {
                userId: parseInt(currentUserId),
                isTyping: true
            };

            log(`íƒ€ì´í•‘ ì‹œì‘: ${JSON.stringify(typingRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/typing`,
                body: JSON.stringify(typingRequest)
            });
        }

        function stopTyping() {
            if (!isConnected) return;

            const typingRequest = {
                userId: parseInt(currentUserId),
                isTyping: false
            };

            log(`íƒ€ì´í•‘ ì¤‘ë‹¨: ${JSON.stringify(typingRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/typing`,
                body: JSON.stringify(typingRequest)
            });
        }

        function markAsRead() {
            if (!isConnected) return;

            const readRequest = {
                userId: parseInt(currentUserId),
                lastReadMessageId: null
            };

            log(`ì½ìŒ ì²˜ë¦¬: ${JSON.stringify(readRequest)}`, 'info');
            stompClient.publish({
                destination: `/app/chat/${currentChatRoomId}/read`,
                body: JSON.stringify(readRequest)
            });
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            
            const senderType = message.senderType;
            const content = message.content;
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            
            if (senderType === 'USER') {
                messageEl.className = 'message user-message';
                messageEl.innerHTML = `<strong>ë‚˜:</strong> ${content} <small>(${timestamp})</small>`;
            } else if (senderType === 'PET') {
                messageEl.className = 'message pet-message';
                messageEl.innerHTML = `<strong>ğŸ¶ í«:</strong> ${content} <small>(${timestamp})</small>`;
            } else if (senderType === 'SYSTEM') {
                messageEl.className = 'message system-message';
                messageEl.innerHTML = `<strong>ì‹œìŠ¤í…œ:</strong> ${content} <small>(${timestamp})</small>`;
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message system-message';
            messageEl.innerHTML = `<strong>ì‹œìŠ¤í…œ:</strong> ${content}`;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleTypingStatus(typingMessage) {
            const chatMessages = document.getElementById('chatMessages');
            const existingTyping = document.getElementById('typing-indicator');
            
            if (existingTyping) {
                existingTyping.remove();
            }
            
            if (typingMessage.messageType === 'TYPING' && 
                typingMessage.userId.id != currentUserId) {
                const typingEl = document.createElement('div');
                typingEl.id = 'typing-indicator';
                typingEl.className = 'message typing-indicator';
                typingEl.innerHTML = 'ğŸ¶ í«ì´ íƒ€ì´í•‘ ì¤‘...';
                chatMessages.appendChild(typingEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ WebSocketì— ì—°ê²°í•˜ì„¸ìš”.');
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            if (isConnected) {
                disconnect();
            }
        });
    </script>
</body>
</html>